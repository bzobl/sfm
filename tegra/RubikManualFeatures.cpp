#include "RubikManualFeatures.h"

RubikManualFeatures::~RubikManualFeatures()
{

}

bool RubikManualFeatures::findFeatures(Frame *frame)
{
  auto iter = mRubikIndices.find(frame);
  if (iter == mRubikIndices.end()) {
    return false;
  }

  std::vector<cv::KeyPoint> kp1;
  cv::KeyPoint::convert(getRubikPoints(iter->second), kp1);
  frame->setKeypoints(kp1);

  return true;
}

ViewCombination RubikManualFeatures::matchFrames(Frame *left, Frame *right)
{
  assert(left->getKeypointsSize() == 91);
  assert(right->getKeypointsSize() == 91);

  ViewCombination view(left, right);

  std::vector<cv::DMatch> good_matches;
  for (size_t i = 0; i < left->getKeypointsSize(); i++) {
    good_matches.emplace_back(i, i, 0);
  }

  view.setMatches(good_matches);

  return view;
}

void RubikManualFeatures::preloadFrame(Frame *frame, size_t rub_idx)
{
  mRubikIndices.insert(std::make_pair(frame, rub_idx));
}

std::vector<cv::Point2f> RubikManualFeatures::getRubikPoints(size_t idx) const
{
  switch (idx) {
    case 1:
      return getRubik1Points();
    case 2:
      return getRubik2Points();
    case 3:
      return getRubik3Points();
    case 4:
      return getRubik4Points();
  }
  assert(false);
}

std::vector<cv::Point2f> RubikManualFeatures::getRubik1Points() const
{
  return std::vector<cv::Point2f> {
    { 377.097175521184, 219.055133079848 },
    { 380.540349697377, 252.819391634981 },
    { 385.705110961668, 288.408745247148 },
    { 388.287491593813, 319.435361216730 },
    { 393.452252858104, 349.549429657795 },
    { 396.034633490249, 377.838403041825 },
    { 402.060188298588, 227.268060836502 },
    { 404.642568930733, 261.944866920152 },
    { 409.807330195024, 297.534220532320 },
    { 413.250504371217, 328.560836501901 },
    { 415.832885003362, 358.674904942966 },
    { 418.415265635508, 386.051330798479 },
    { 429.605581708137, 236.393536121673 },
    { 433.048755884331, 271.982889733840 },
    { 437.352723604573, 307.572243346008 },
    { 440.795897780767, 339.511406844107 },
    { 442.517484868863, 371.450570342205 },
    { 442.517484868863, 398.826996197719 },
    { 457.150975117687, 248.256653992396 },
    { 460.594149293880, 282.933460076046 },
    { 465.758910558171, 317.610266159696 },
    { 468.341291190316, 349.549429657795 },
    { 470.062878278413, 379.663498098859 },
    { 469.202084734364, 410.690114068441 },
    { 489.000336247478, 257.382129277567 },
    { 490.721923335575, 292.971482889734 },
    { 495.025891055817, 327.648288973384 },
    { 497.608271687962, 360.500000000000 },
    { 497.608271687962, 390.614068441065 },
    { 496.747478143914, 420.728136882129 },
    { 519.128110289173, 266.507604562738 },
    { 523.432078009415, 303.009505703422 },
    { 525.153665097512, 338.598859315589 },
    { 525.153665097512, 369.625475285171 },
    { 525.153665097512, 401.564638783270 },
    { 528.596839273705, 434.416349809886 },
    { 546.673503698722, 251.906844106464 },
    { 550.977471418964, 285.671102661597 },
    { 553.559852051110, 321.260456273764 },
    { 553.559852051110, 354.112167300380 },
    { 552.699058507061, 385.138783269962 },
    { 554.420645595158, 414.340304182510 },
    { 569.054135843981, 240.043726235742 },
    { 574.218897108272, 273.807984790875 },
    { 574.218897108272, 306.659695817491 },
    { 575.079690652320, 338.598859315589 },
    { 575.940484196368, 369.625475285171 },
    { 577.662071284465, 397.001901140685 },
    { 594.017148621385, 227.268060836502 },
    { 594.877942165434, 261.944866920152 },
    { 596.599529253531, 292.058935361217 },
    { 595.738735709482, 324.910646387833 },
    { 595.738735709482, 356.849809885932 },
    { 597.460322797579, 384.226235741445 },
    { 614.676193678547, 214.492395437262 },
    { 614.676193678547, 249.169201520913 },
    { 614.676193678547, 281.108365019012 },
    { 614.676193678547, 313.047528517110 },
    { 614.676193678547, 342.249049429658 },
    { 614.676193678547, 371.450570342205 },
    { 634.474445191661, 205.366920152091 },
    { 634.474445191661, 239.131178707224 },
    { 632.752858103564, 270.157794676806 },
    { 631.892064559516, 302.096958174905 },
    { 631.892064559516, 330.385931558935 },
    { 631.892064559516, 355.024714828897 },
    { 501.051445864156, 168.865019011407 },
    { 480.392400806994, 176.165399239544 },
    { 456.290181573638, 185.290874524715 },
    { 433.909549428379, 194.416349809886 },
    { 405.503362474781, 206.279467680609 },
    { 520.849697377270, 176.165399239544 },
    { 501.912239408204, 183.465779467681 },
    { 479.531607262946, 193.503802281369 },
    { 454.568594485541, 203.541825095057 },
    { 430.466375252186, 214.492395437262 },
    { 548.395090786819, 182.553231939164 },
    { 528.596839273705, 191.678707224335 },
    { 506.216207128447, 200.804182509506 },
    { 484.696368527236, 212.667300380228 },
    { 457.150975117687, 221.792775665399 },
    { 574.218897108272, 189.853612167301 },
    { 555.281439139206, 198.066539923954 },
    { 533.761600537996, 208.104562737643 },
    { 511.380968392737, 220.880228136882 },
    { 486.417955615333, 232.743346007605 },
    { 602.625084061869, 197.153992395437 },
    { 583.687626092804, 206.279467680609 },
    { 562.167787491594, 217.230038022814 },
    { 538.926361802286, 227.268060836502 },
    { 514.824142568931, 240.043726235742 },
  };
}

std::vector<cv::Point2f> RubikManualFeatures::getRubik2Points() const
{
  return std::vector<cv::Point2f> {
    { 186.861802286483, 241.868821292776 },
    { 193.748150638870, 277.458174904943 },
    { 203.216879623403, 317.610266159696 },
    { 209.242434431742, 348.636882129278 },
    { 217.850369872226, 377.838403041825 },
    { 224.736718224613, 406.127376425856 },
    { 204.077673167451, 252.819391634981 },
    { 209.242434431742, 289.321292775666 },
    { 220.432750504371, 327.648288973384 },
    { 228.179892400807, 362.325095057034 },
    { 235.927034297243, 394.264258555133 },
    { 241.091795561533, 419.815589353612 },
    { 224.736718224613, 264.682509505704 },
    { 229.040685944855, 303.922053231939 },
    { 240.231002017485, 341.336501901141 },
    { 247.117350369872, 376.925855513308 },
    { 254.003698722260, 407.952471482890 },
    { 258.307666442502, 434.416349809886 },
    { 244.534969737727, 279.283269961977 },
    { 250.560524546066, 318.522813688213 },
    { 260.890047074647, 355.024714828897 },
    { 267.776395427034, 389.701520912548 },
    { 273.801950235373, 423.465779467681 },
    { 278.105917955615, 451.754752851711 },
    { 265.194014794889, 294.796577946768 },
    { 272.080363147276, 333.123574144487 },
    { 281.549092131809, 371.450570342205 },
    { 288.435440484196, 408.865019011407 },
    { 294.460995292535, 439.891634980989 },
    { 299.625756556826, 469.093155893536 },
    { 290.157027572293, 306.659695817491 },
    { 299.625756556826, 349.549429657795 },
    { 305.651311365165, 386.051330798479 },
    { 312.537659717552, 422.553231939164 },
    { 315.980833893746, 455.404942965780 },
    { 321.145595158036, 489.169201520913 },
    { 331.475117686617, 291.146387832700 },
    { 340.083053127102, 331.298479087453 },
    { 347.830195023537, 368.712927756654 },
    { 353.855749831876, 404.302281368821 },
    { 356.438130464021, 437.153992395437 },
    { 362.463685272360, 469.093155893536 },
    { 371.071620712845, 278.370722433460 },
    { 376.236381977135, 317.610266159696 },
    { 383.983523873571, 353.199619771863 },
    { 388.287491593813, 387.876425855513 },
    { 392.591459314055, 420.728136882129 },
    { 396.895427034297, 451.754752851711 },
    { 408.085743106927, 263.769961977186 },
    { 413.250504371217, 304.834600760456 },
    { 417.554472091459, 338.598859315589 },
    { 421.858439811701, 372.363117870723 },
    { 424.440820443847, 406.127376425856 },
    { 427.023201075992, 438.066539923954 },
    { 440.795897780767, 252.819391634981 },
    { 445.960659045057, 291.146387832700 },
    { 450.264626765299, 324.910646387833 },
    { 453.707800941493, 358.674904942966 },
    { 455.429388029590, 390.614068441065 },
    { 458.872562205783, 422.553231939164 },
    { 475.227639542703, 243.693916349810 },
    { 477.810020174849, 280.195817490494 },
    { 479.531607262946, 312.134980988593 },
    { 482.113987895091, 346.811787072243 },
    { 485.557162071284, 378.750950570342 },
    { 486.417955615333, 407.039923954373 },
    { 362.463685272360, 191.678707224335 },
    { 333.196704774714, 199.891634980989 },
    { 300.486550100874, 208.104562737643 },
    { 265.194014794889, 218.142585551331 },
    { 229.901479488904, 229.093155893536 },
    { 379.679556153329, 199.891634980989 },
    { 347.830195023537, 209.929657794677 },
    { 315.980833893746, 218.142585551331 },
    { 280.688298587761, 229.093155893536 },
    { 246.256556825824, 240.043726235742 },
    { 399.477807666442, 209.017110266160 },
    { 371.071620712845, 218.142585551331 },
    { 340.083053127102, 229.093155893536 },
    { 304.790517821116, 240.043726235742 },
    { 263.472427706792, 250.994296577947 },
    { 422.719233355750, 219.967680608365 },
    { 393.452252858104, 229.093155893536 },
    { 359.020511096167, 240.043726235742 },
    { 323.727975790182, 251.906844106464 },
    { 283.270679219906, 263.769961977186 },
    { 445.960659045057, 229.093155893536 },
    { 415.832885003362, 241.868821292776 },
    { 382.261936785474, 251.906844106464 },
    { 345.247814391392, 262.857414448669 },
    { 307.372898453262, 276.545627376426 },
  };
}

std::vector<cv::Point2f> RubikManualFeatures::getRubik3Points() const
{
  return std::vector<cv::Point2f> {
    { 501.0514, 217.2300 },
    { 501.9122, 252.8194 },
    { 504.4946, 283.8460 },
    { 507.0770, 314.8726 },
    { 508.7986, 344.9867 },
    { 511.3810, 373.2757 },
    { 513.1026, 227.2681 },
    { 513.1026, 263.7700 },
    { 515.6849, 297.5342 },
    { 517.4065, 327.6483 },
    { 519.1281, 358.6749 },
    { 519.9889, 386.0513 },
    { 526.8753, 241.8688 },
    { 526.0145, 278.3707 },
    { 528.5968, 311.2224 },
    { 530.3184, 341.3365 },
    { 531.1792, 372.3631 },
    { 533.7616, 399.7395 },
    { 541.5087, 256.4696 },
    { 540.6479, 292.0589 },
    { 542.3695, 325.8232 },
    { 543.2303, 360.5000 },
    { 546.6735, 394.2643 },
    { 546.6735, 417.9905 },
    { 559.5854, 271.0703 },
    { 558.7246, 310.3099 },
    { 559.5854, 343.1616 },
    { 560.4462, 378.7510 },
    { 561.3070, 407.9525 },
    { 561.3070, 437.1540 },
    { 575.9405, 286.5837 },
    { 575.0797, 323.0856 },
    { 576.8013, 360.5000 },
    { 577.6621, 392.4392 },
    { 576.8013, 426.2034 },
    { 577.6621, 459.9677 },
    { 614.6762, 279.2833 },
    { 615.5370, 316.6977 },
    { 615.5370, 352.2871 },
    { 615.5370, 386.9639 },
    { 616.3978, 418.9030 },
    { 616.3978, 449.0171 },
    { 650.8295, 271.0703 },
    { 650.8295, 309.3973 },
    { 650.8295, 344.0741 },
    { 649.9687, 376.9259 },
    { 649.1079, 410.6901 },
    { 646.5256, 441.7167 },
    { 686.9829, 262.8574 },
    { 686.1221, 303.0095 },
    { 684.4005, 337.6863 },
    { 682.6789, 367.8004 },
    { 680.9573, 401.5646 },
    { 679.2357, 432.5913 },
    { 721.4146, 256.4696 },
    { 718.8322, 294.7966 },
    { 717.9714, 327.6483 },
    { 715.3890, 360.5000 },
    { 714.5282, 391.5266 },
    { 711.9459, 422.5532 },
    { 754.1247, 250.9943 },
    { 750.6816, 288.4087 },
    { 748.9600, 320.3479 },
    { 747.2384, 352.2871 },
    { 743.7952, 384.2262 },
    { 741.2128, 413.4278 },
    { 661.1590, 187.1160 },
    { 631.8921, 190.7662 },
    { 600.0427, 197.1540 },
    { 569.9149, 202.6293 },
    { 538.0656, 209.0171 },
    { 678.3749, 198.0665 },
    { 646.5256, 203.5418 },
    { 614.6762, 209.0171 },
    { 582.8268, 215.4049 },
    { 547.5343, 220.8802 },
    { 693.0084, 208.1046 },
    { 664.6022, 216.3175 },
    { 632.7529, 221.7928 },
    { 598.3211, 227.2681 },
    { 563.8894, 233.6559 },
    { 711.0851, 219.9677 },
    { 682.6789, 227.2681 },
    { 648.2471, 233.6559 },
    { 612.9546, 240.9563 },
    { 578.5229, 247.3441 },
    { 730.8833, 233.6559 },
    { 702.4771, 241.8688 },
    { 668.0454, 247.3441 },
    { 631.8921, 254.6445 },
    { 594.0171, 261.9449 }
  };
}

std::vector<cv::Point2f> RubikManualFeatures::getRubik4Points() const
{
  return std::vector<cv::Point2f> {
    { 408.9465, 226.3555 },
    { 413.2505, 256.4696 },
    { 417.5545, 282.0209 },
    { 421.8584, 308.4848 },
    { 426.1624, 332.2110 },
    { 427.8840, 351.3745 },
    { 425.3016, 238.2186 },
    { 427.0232, 267.4202 },
    { 430.4664, 293.8840 },
    { 433.9095, 318.5228 },
    { 439.0743, 344.0741 },
    { 439.9351, 365.9753 },
    { 439.0743, 252.8194 },
    { 440.7959, 283.8460 },
    { 445.0999, 310.3099 },
    { 449.4038, 337.6863 },
    { 451.9862, 358.6749 },
    { 452.8470, 381.4886 },
    { 455.4294, 268.3327 },
    { 456.2902, 297.5342 },
    { 459.7334, 323.0856 },
    { 464.8981, 351.3745 },
    { 466.6197, 376.0133 },
    { 468.3413, 397.0019 },
    { 472.6453, 282.9335 },
    { 473.5061, 313.0475 },
    { 476.9492, 341.3365 },
    { 479.5316, 366.8878 },
    { 482.1140, 391.5266 },
    { 482.1140, 412.5152 },
    { 489.0003, 297.5342 },
    { 492.4435, 327.6483 },
    { 495.0259, 355.0247 },
    { 496.7475, 379.6635 },
    { 500.1907, 406.1274 },
    { 501.9122, 431.6787 },
    { 521.7105, 285.6711 },
    { 524.2929, 316.6977 },
    { 526.0145, 344.0741 },
    { 528.5968, 370.5380 },
    { 529.4576, 395.1768 },
    { 530.3184, 419.8156 },
    { 551.8383, 277.4582 },
    { 553.5599, 304.8346 },
    { 554.4206, 333.1236 },
    { 556.1422, 356.8498 },
    { 557.0030, 382.4011 },
    { 558.7246, 407.9525 },
    { 580.2445, 265.5951 },
    { 581.1052, 294.7966 },
    { 581.9660, 321.2605 },
    { 581.9660, 345.8992 },
    { 582.8268, 370.5380 },
    { 583.6876, 397.0019 },
    { 607.7898, 255.5570 },
    { 607.7898, 282.9335 },
    { 607.7898, 310.3099 },
    { 607.7898, 336.7738 },
    { 608.6506, 360.5000 },
    { 608.6506, 384.2262 },
    { 633.6137, 246.4316 },
    { 633.6137, 275.6331 },
    { 632.7529, 301.1844 },
    { 631.8921, 323.0856 },
    { 631.0313, 349.5494 },
    { 631.8921, 374.1882 },
    { 544.9519, 181.6407 },
    { 521.7105, 189.8536 },
    { 495.0259, 197.1540 },
    { 468.3413, 205.3669 },
    { 439.9351, 215.4049 },
    { 562.1678, 193.5038 },
    { 534.6224, 201.7167 },
    { 509.6594, 210.8422 },
    { 482.1140, 219.0551 },
    { 453.7078, 229.0932 },
    { 577.6621, 204.4544 },
    { 551.8383, 213.5798 },
    { 525.1537, 221.7928 },
    { 498.4691, 231.8308 },
    { 468.3413, 241.8688 },
    { 594.8779, 216.3175 },
    { 569.9149, 226.3555 },
    { 541.5087, 236.3935 },
    { 513.9633, 245.5190 },
    { 483.8356, 255.5570 },
    { 613.8154, 230.0057 },
    { 587.1308, 240.0437 },
    { 559.5854, 250.0817 },
    { 532.9008, 259.2072 },
    { 502.7730, 270.1578 },
  };
}
